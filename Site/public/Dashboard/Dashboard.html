<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="shortcut icon" href="logo.png" type="image/x-icon">
  <link rel="stylesheet" type="text/css" href="dashboardStyle.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <!--Tela de perfil
  <div class="div_tela_perfil" id="div_tela_perfil">

    <img src="https://cdn-icons-png.flaticon.com/128/1246/1246211.png" onclick="Voltar()" class="voltar">
    <div class="pconteiner">
      <div class="image"><img class="foto" src="user.png" alt=""></div>

      <h1>Meu perfil</h3>

        <h3>Nome Completo:</h3>
        <div class="nome">
          <p class="paragrafo" id="receptor">
          </p>
          <input class="campo" id="div_nome_perfil" style="display: none;" type="text">
          <button onclick="editarnome()" class="bottao">
            <img class="editar" src="pen.png" alt="">
          </button>

        </div>


        <h3>Email:</h3>
        <div class="nome">
          <p class="paragrafo" id="receptor2">
          </p>
          <input class="campo" id="div_email_perfil" style="display: none;" type="text">
          <button onclick="editaremail()" class="bottao">
            <img class="editar" src="pen.png" alt="">
          </button>
        </div>

        <h3>Celular:</h3>
        <div class="nome">
          <p class="paragrafo" id="receptor3">
            (11)977135556
          </p>
          <input class="campo" id="celular" style="display: none;" type="text">
          <button onclick="editarcell()" class="bottao">
            <img class="editar" src="pen.png" alt="">
          </button>
        </div>

        <h3>Senha:</h3>
        <div class="nome">
          <p class="paragrafo" id="receptor4">
            Afonso123
          </p>
          <input class="campo" id="senha" style="display: none;" type="text">
          <button onclick="editarsenha()" class="bottao">
            <img class="editar" src="pen.png" alt="">
          </button>
        </div>

    </div>
    <div id="exibir"></div>
  </div>

-->
  <!-- Tela de formulario -->
  <div class="tela-form-ajuda" id="div_tela_form_ajuda">
    <div class="header-ajuda">
      <img src="undo.png" onclick="Voltar()" class="voltar">
    </div>
    <div class="faixa-form">

      <div class="faixa-linha">
        <img src="telefone.png">
        <b>Telefone:</b> (11) 91824567
      </div>
      <div class="faixa-linha">
        <img src="email.png">
        <b>Email:</b> datatemptrack@gmail.com
      </div>
      <div class="faixa-linha">
        <img src="horas.png">
        <b>Horário De Atendimento:</b> Seg-Sex 10h-17h
      </div>
    </div>
    <div class="div-form">
      <!--<form--->
      <div>
        <h1>Contate - Nos
        </h1>
      </div>

      <div class="help_desk">


        <iframe src='https://app.pipefy.com/public/form/YcYXyBxJ?embedded=true' frameborder='0'></iframe>
      </div>
      <!--<div class="pedaco-formulario">
          <input type="text" id="nome" name="Nome" placeholder="Digite aqui seu nome">
        </div>
        <div class="pedaco-formulario">
          <input type="email" id="email" name="Email para contato" placeholder="Digite aqui seu email para contato">
        </div>
        <div class="pedaco-formulario">
          <input type="text" id="assunto" name="Assunto" placeholder="Digite aqui o assunto">
        </div>
        <div class="pedaco-formulario">
          <input type="text" id="problema" name="Descrição do problema" placeholder="Descreva seu problema">
        </div>
        <button type="submit">Enviar</button>
      </form>
    </div>--->
    </div>
  </div>


  <!--Tela inicial -->
  <div class="tela_dashboard" id="div_tela_dashboard">
    <div class="menu_lateral" id="divMenu_lateral">
      <div class="perfil_img">
        <img src="https://cdn-icons-png.flaticon.com/512/4211/4211178.png" onclick="chamarPerfil()">
        <div class="perfil_text">
          <b> Usuário: <span id="nomeUsuario"></span><br></b>

        </div>
      </div>
      <div class="menuDC" id="div_menuDC">

        <!-- <div class="piscar-vermelho-dc">
            <p>ALERTA</p>
          </div>-->
      </div>
      <button class="config" onclick="Ajuda()">Ajuda</button>

      <button onclick="redirecionarTuto()" class="config3">Entenda o site</button>
    </div>
    <div class="lousa">
      <div id="div_text_inicial" class="text_inicial">
        <div class="messageErro" id="messageErro"></div>
        Escolha um Data Center
      </div>
      <div id="div_lousa_invisivel" class="lousa_invisivel">
        <div id="div_card_linha" class="card_linha">
          <div id="div_card_grande_dc" class="card_grande" onclick="TemUmiDataCenter()">
            <div class="baixo">
              Data Center
            </div>
          </div>
        </div>
        <div id="div_card_linha2" class="card_linha">


        </div>
      </div>

      <!-- FIM DATA CENTER 1 -->


      <div id="div_lousa_invisivel1" class="lousa_invisivel1">
        <div id="div_card_linha" class="card_linha">
          <div id="div_card_grande_dc" class="card_grande" onclick="TemUmiDataCenter()">
            <div class="baixo">
              Data Center
            </div>
          </div>
        </div>
        <div id="div_card_linha2" class="card_linha">

        </div>
      </div>



      <!--Tela dos Corredores -->
      <div id="div_lousa_invisivel2" class="lousa_invisivel2">
        <div id="div_card_linha" class="card_linha">
          <div id="div_card_grande_corredor" class="card_grande" onclick="TemUmiDataCenter()">
            <div class="baixo">
              Corredor 01
            </div>
          </div>
        </div>
        <div id="div_card_linha" class="card_linha">
          <div id="div_card_unidade" value="rack01" class="card_unidade" onclick="TemUmiDataCenter('Rack 01')">
            <div class="cima">
              <img src="rack.png" class="imagem_corredor">
              <div class="cima-direita">
                <img src="https://cdn-icons-png.flaticon.com/128/728/728093.png" class="imagem_gota">
                <img src="temperatura.png" class="imagem_gota">
              </div>
            </div>
            <div id="textoRackNome" class="baixo">
              Rack 01
            </div>
          </div>
          <div id="div_card_unidade" value="rack02" class="card_unidade" onclick="TemUmiDataCenter('Rack 02')">
            <div class="cima">
              <img src="rack.png" class="imagem_corredor">
              <div class="cima-direita">
                <img src="https://cdn-icons-png.flaticon.com/128/728/728093.png" class="imagem_gota">
                <img src="temperatura.png" class="imagem_gota">
              </div>
            </div>
            <div id="textoRackNome" class="baixo">
              Rack 02
            </div>
          </div>
          <div id="div_card_unidade" value="rack03" class="card_unidade" onclick="TemUmiDataCenter('Rack 03')">
            <div class="cima">
              <img src="rack.png" class="imagem_corredor">
              <div class="cima-direita">
                <img src="https://cdn-icons-png.flaticon.com/128/728/728093.png" class="imagem_gota">
                <img src="temperatura.png" class="imagem_gota">
              </div>
            </div>
            <div id="textoRackNome" class="baixo">
              Rack 03
            </div>
          </div>
        </div>
      </div>







      <!--Tela Dos Graficos do Data Center -->
      <div id="div_lousa_invisivel3" class="lousa_invisivel3">
        <div class="alinhar_lousa3">

          <div class="menu">

            <div class="tamanho">
              <img src="undo.png" onclick="dataCenter()" class="bottom_voltar">
            </div>

            <div class="localizacao">
              <div id="div_texto_localizacao" class="texto_localizacao">

              </div>
            </div>

          </div>


          <div class="dash">

            <div class="regua">
              <div class="item-regua ideal">
                <h4>Ideal</h4>
                <h2>19°C <br>a <br> 24°C</h2>
              </div>
              <div class="item-regua alerta">
                <h4>Alerta</h4>
                <h2>12°C a 18°C <br>e<br /> 25°C a 28°C </h2>
              </div>
              <div class="item-regua danger">
                <h4>Perigo</h4>
                <h2>
                  Menor que 12°C <br>e <br> Maior que 28°C
                </h2>
              </div>

              <div class="item-regua espaco">

              </div>

              <div class="item-regua ideal">
                <h4>Ideal</h4>
                <h2> 42% <br>a <br> 58%
                </h2>
              </div>
              <div class="item-regua alerta">
                <h4>Alerta</h4>
                <h2>35% a 41% <br>e<br /> 59% a 64% </h2>
              </div>
              <div class="item-regua danger">
                <h4>Perigo</h4>
                <h2>Menor que 35% <br>e <br> Maior 64%</h2>
              </div>
            </div>
          </div>







          <div class="medicao_atual" id="div_medicao_atual">
            <div class="medicaoAlert" id="medicaoAlertT">Temperatura:°C</div>
            <div class="medicaoAlert" id="medicaoAlertU"> Umidade: %</div>
          </div>
          <div class="container-canvas_01" id="id_container_canvas_01">
            <canvas id="id_grafico_temperatura"></canvas>
            <canvas id="id_grafico_umidade"></canvas>
          </div>
          <div class="tabela_bloqueio" id="div_tabela_bloqueio">
          </div>


        </div>
      </div>
</body>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</html>
<script>

  /*Pegar os datas center da empresa pelo id do usuario*/
  var menu = document.getElementById('div_menuDC');
  setTimeout(buscarDC, 10)

  function buscarDC() {
    var fkEmpresaVar = sessionStorage.FK_EMPRESA;
    fetch("/dataCenter/listarDC", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        idEmpresaServer: fkEmpresaVar,
      })
    }).then(function (resposta) {
      if (resposta.ok) {
        resposta.json().then(function (resposta) {
          for (contador = 0; contador < resposta.length; contador++) {
            var dc = resposta[contador];
            menu.innerHTML += `
              <button onclick="dataCenter(${dc.idDataCenter})"><span><b id="div_nomeDC">${dc.unidDataCenter}</b></span></button>
                  `;
          }
        })
      }
    })
      .catch(
        function (erro) {
          res.status(500).json(erro.sqlMessage);

        })
  }

/*Pegar os ambientes*/Ajuda
  var cardLinha = document.getElementById('div_card_linha2');

  function listarAmb() {
    cardLinha.innerHTML = '';
    var fkEmpresaVar = sessionStorage.FK_EMPRESA;
    var nomeDCVar = document.getElementById('div_nomeDC').innerText;

    fetch("/ambiente/listarAmb", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        idEmpresaServer: fkEmpresaVar,
        nomeDCServer: nomeDCVar,
      })
    }).then(function (resposta) {
      if (resposta.ok) {
        resposta.json().then(function (resposta) {
          for (contador = 0; contador < resposta.length; contador++) {
            var rack = resposta[contador];

            if (rack.nomeAmbiente == 'Porta') {
              cardLinha.innerHTML += `
            <div id="div_card_porta" class="card_unidade">
              <div class="cima">
                <img src="https://cdn-icons-png.flaticon.com/128/566/566489.png" class="imagem_corredor">
              </div>
              <div class="baixo">
              ${rack.nomeAmbiente}
              <div id="abertoFechado">
                
                </div>
              </div>
            </div>
                  `;
            } else {
              cardLinha.innerHTML += `
            <div id="div_card_unidade" class="card_unidade" onclick="chamarRack()">
              <div class="cima">
                <img src="rack.png" class="imagem_corredor">
                <div class="cima-direita">
                  <img src="https://cdn-icons-png.flaticon.com/128/728/728093.png" class="imagem_gota">
                  <img src="temperatura.png" class="imagem_gota">
                </div>
              </div>
              <div class="baixo">
              ${rack.nomeAmbiente}
              </div>
            </div>
                  `;
            }
          }
        })
      }
    })
      .catch(
        function (erro) {
          res.status(500).json(erro.sqlMessage);

        })
  }






  /*Dashboard como um todo*/
  var nomeUsuario = document.getElementById('nomeUsuario');
  var nomeUsuarioS = sessionStorage.NOME_USUARIO;
  nomeUsuario.innerHTML = nomeUsuarioS;

  var temperaturaAtual1 = 20.54;
  var umidadeAtual1 = 51;
  var temperaturaAtual2 = 20.15;
  var umidadeAtual2 = 50;
  var temperaturaAtual3 = 19.30;
  var umidadeAtual3 = 55;

  var tela_form_ajuda = document.getElementById('div_tela_form_ajuda');
  var tela_dashboard = document.getElementById('div_tela_dashboard');
  var text_inicial = document.getElementById('div_text_inicial');
  var lousa_invisivel = document.getElementById('div_lousa_invisivel');
  var lousa_invisivel1 = document.getElementById('div_lousa_invisivel1');
  var lousa_invisivel2 = document.getElementById('div_lousa_invisivel2');
  var lousa_invisivel3 = document.getElementById('div_lousa_invisivel3');
  var container_canvas1 = document.getElementById('id_container_canvas_01');
  var container_canvas2 = document.getElementById('id_container_canvas_02');
  var container_canvas3 = document.getElementById('id_container_canvas_03');
  var botao_lousa3_01 = document.getElementById('div_botao_lousa3_01');
  var botao_lousa3_02 = document.getElementById('div_botao_lousa3_02');
  var botao_lousa3_03 = document.getElementById('div_botao_lousa3_03');


  var tabela_bloqueio = document.getElementById('div_tabela_bloqueio');

  function chamarPerfil() {
    text_inicial.style.display = "none";
    tela_form_ajuda.style.display = "none";
    text_inicial.style.display = "none";
    lousa_invisivel.style.display = "none";
    lousa_invisivel1.style.display = "none"
    lousa_invisivel2.style.display = "none";
    lousa_invisivel3.style.display = "none";
    tela_dashboard.style.display = "none";
    tabela_bloqueio.style.display = "none";
  }

  function dataCenter(idDataCenter) {
    var fkEmpresa = sessionStorage.FK_EMPRESA
    text_inicial.style.display = "none";
    tela_form_ajuda.style.display = "none";
    text_inicial.style.display = "none";
    lousa_invisivel.style.display = "flex";
    lousa_invisivel1.style.display = "none"
    lousa_invisivel2.style.display = "none";
    lousa_invisivel3.style.display = "none";
    tabela_bloqueio.style.display = "none";
    listarAmb()
    obterDadosGrafico(fkEmpresa)
  }

  function Ajuda() {
    text_inicial.style.display = "none";
    tela_form_ajuda.style.display = "flex";
    text_inicial.style.display = "none";
    lousa_invisivel.style.display = "none";
    lousa_invisivel1.style.display = "none"
    lousa_invisivel2.style.display = "none";
    lousa_invisivel3.style.display = "none";
    tela_dashboard.style.display = "none";
    tabela_bloqueio.style.display = "none";

  }
  function Voltar() {
    tela_dashboard.style.display = "flex";
    text_inicial.style.display = "flex";
    tela_form_ajuda.style.display = "none";
    lousa_invisivel.style.display = "none";
    lousa_invisivel1.style.display = "none"
    lousa_invisivel2.style.display = "none";
    lousa_invisivel3.style.display = "none";
    tabela_bloqueio.style.display = "none";

  }
  function TemUmiDataCenter(nomeLocalizacao) {

    var fkEmpresa = sessionStorage.FK_EMPRESA

    text_inicial.style.display = "none";
    tela_form_ajuda.style.display = "none";
    text_inicial.style.display = "none";
    lousa_invisivel.style.display = "none";
    lousa_invisivel1.style.display = "none"
    lousa_invisivel2.style.display = "none";
    lousa_invisivel3.style.display = "flex";
    tabela_bloqueio.style.display = "none";

    var textoLocalizacaoDiv = document.getElementById('div_texto_localizacao');
    textoLocalizacaoDiv.innerHTML = nomeLocalizacao;

    obterDadosGrafico(fkEmpresa)

  }

  function TemUmiDataCenter() {

    text_inicial.style.display = "none";
    tela_form_ajuda.style.display = "none";
    text_inicial.style.display = "none";
    lousa_invisivel.style.display = "none";
    lousa_invisivel1.style.display = "none"
    lousa_invisivel2.style.display = "none";
    lousa_invisivel3.style.display = "flex";
    tabela_bloqueio.style.display = "flex";



  }
  function chamarRack() {
    text_inicial.style.display = "none";
    tela_form_ajuda.style.display = "none";
    text_inicial.style.display = "none";
    lousa_invisivel.style.display = "none";
    lousa_invisivel1.style.display = "none"
    lousa_invisivel2.style.display = "flex";
    lousa_invisivel3.style.display = "none";
    tabela_bloqueio.style.display = "none";

  }








  /*Graficos Umidade*/
  const label = [
    '5min',
    '4min',
    '3min',
    '2min',
    '1min',
    'Min atual',
  ];



  Chart.defaults.borderColor = '#f2f2f2';
  Chart.defaults.color = '#fff';


  const data = {
    labels: label,
    datasets: [{
      label: 'Umidade (%)',
      backgroundColor: 'blue',
      borderColor: 'blue',
      data: [50,
        50,
        50,
        50,
        51,
        50,
        51],
    }]
  };


  const config = {
    type: 'line',
    data: data,
    options: {}
  };


  const grafico_umidade = new Chart(
    document.getElementById('id_grafico_umidade'),
    config
  );

  /*Graficos Temperatura*/
  const label4 = [
    '5min',
    '4min',
    '3min',
    '2min',
    '1min',
    'Min atual',
  ];


  const data4 = {
    labels: label4,
    datasets: [{
      label: 'Temperatura (°C)',
      backgroundColor: 'green',
      borderColor: 'green',
      data: [19.78,
        20.04,
        20.88,
        21.10,
        20.97,
        20.62,
        20.54],
    }]
  };


  const config4 = {
    type: 'line',
    data: data4,
    options: {}
  };


  const grafico_temperatura = new Chart(
    document.getElementById('id_grafico_temperatura'),
    config4
  );




  var proximaAtualizacao;


  function obterDadosGrafico(idAmb) {

    if (proximaAtualizacao != undefined) {
      clearTimeout(proximaAtualizacao);
    }

    fetch(`/medida/ultimas/${idAmb}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();
          plotarGrafico(resposta, idAmb);

        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }

  // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
  // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
  // A função *plotarGrafico* também invoca a função *atualizarGrafico*
  function plotarGrafico(resposta, idAmb) {

    console.log('iniciando plotagem do gráfico...');


    // Criando estrutura para plotar gráfico - dados
    console.log('----------------------------------------------')
    console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
    console.log(resposta)

    setTimeout(() => atualizarGrafico(idAmb, data4, data, grafico_temperatura, grafico_umidade), 1500);
  }


  /*Alterar depois para atualizar gráficos*/

  // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
  // buscando a última medida inserida em tabela contendo as capturas, 

  //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
  //     Para ajustar o "select", ajuste o comando sql em src/models
  function atualizarGrafico(idAmb, data4, data, grafico_temperatura, grafico_umidade) {

    fetch(`/medida/tempo-real/${idAmb}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (novoRegistro) {
          if (novoRegistro[0].dadoCap == data.labels[data.labels.length - 1]) {
            console.log("---------------------------------------------------------------")
            console.log("Como não há dados novos para captura, o gráfico não atualizará.")
            console.log("Horário do novo dado capturado:")
            console.log("Horário do último dado capturado:")
            console.log(data.labels[data.labels.length - 1])
            console.log("---------------------------------------------------------------")
          } else {


            if (novoRegistro[1].dadoCap == 1) {
              abertoFechado.innerHTML = "Aberto"
              abertoFechado.style.backgroundColor = "red"
            } else {
              abertoFechado.innerHTML = "Fechado"
              abertoFechado.style.backgroundColor = "green"
            }

            // Inserindo valores recebidos em estrutura para plotar o gráfico
            for (i = 0; i < response[4]; i++) {
              var registro = response[i];
              if (registro.unidMedida == "ºC") {
                var temperatura = registro.dadoCap
              } else if (registro.unidMedida == "%") {
                var umidade = registro.dadoCap
              } else {
                var proximidade = registro.dadoCap
              }
              label4.push(registro.dataHist);
              label.push(registro.dataHist);
              data.datasets[0].data.push(umidade);
              data4.datasets[0].data.push(temperatura);
            }

            data4.datasets[0].data.shift();  // apagar o primeiro de umidade
            data4.datasets[0].data.push(novoRegistro[0].dadoCap); // incluir uma nova medida de umidade

            data.datasets[0].data.shift();  // apagar o primeiro de temperatura
            data.datasets[0].data.push(novoRegistro[2].dadoCap); // incluir uma nova medida de temperatura
            console.log(div_lousa_invisivel3.style.display);
            if (div_lousa_invisivel3.style.display = 'flex') {
              grafico_temperatura.update();
              grafico_umidade.update();
            }
          }

          // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
          proximaAtualizacao = setTimeout(() => atualizarGrafico(idAmb, data4, data, grafico_temperatura, grafico_umidade), 1500);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
        proximaAtualizacao = setTimeout(() => atualizarGrafico(idAmb, data4, data, grafico_temperatura, grafico_umidade), 1500);
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });


    temperaturaAtual1 = data4.datasets[0].data[5];

    umidadeAtual1 = data.datasets[0].data[5];
    div_medicao_atual.innerHTML = `<div class="medicaoAlert" id="medicaoAlertT">Temperatura: ${temperaturaAtual1}°C</div>
    <div class="medicaoAlert" id="medicaoAlertU"> Umidade:${umidadeAtual1}%</div>`


    if (temperaturaAtual1 >= 19 && temperaturaAtual1 <= 24) {
      medicaoAlertT.style.backgroundColor = "green";
      medicaoAlertT.style.color ="black";
    }
    else if (temperaturaAtual1 >= 12 && temperaturaAtual1 <= 28) {
      medicaoAlertT.style.backgroundColor = "yellow";
      medicaoAlertT.style.color ="black";
    }
    else {
      medicaoAlertT.style.backgroundColor = "red";
      medicaoAlertT.style.color ="black";
     }

    if (umidadeAtual1 >= 42 && umidadeAtual1 <= 58) {
      medicaoAlertU.style.backgroundColor = "green";
      medicaoAlertU.style.color = "black"
    } else if (umidadeAtual1 >= 35 && umidadeAtual1 <= 64) {
      medicaoAlertU.style.backgroundColor = "yellow";
      medicaoAlertU.style.color = "black"
    } else {
      medicaoAlertU.style.backgroundColor = "red";
      medicaoAlertU.style.color = "black"
    }

    

    if (novoRegistro[1].dadoCap == 1) {
              abertoFechado.innerHTML = "Aberto"
              abertoFechado.style.backgroundColor = "red"
            } else {
              abertoFechado.innerHTML = "Fechado"
              abertoFechado.style.backgroundColor = "green"
            }

  }

  function redirecionarTuto() {
    window.location.href = "Dashboard_tutorial/tutorial.html"
  }

</script>